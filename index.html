<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ËÅñË™ï‰∏äÊµ∑‰πãÊóÖ 2025</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&family=Noto+Sans+SC:wght@900&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        scheme1: { 
                            bg: '#0F172A',        
                            primary: '#FF7EE2',   
                            secondary: '#22D3EE', 
                            accent: '#FDE047',    
                            textMain: '#FFFFFF',
                            textSub: '#E2E8F0',
                            cardBg: 'rgba(255, 255, 255, 0.1)' 
                        }
                    },
                    fontFamily: { 
                        sans: ['Noto Sans TC', 'sans-serif'],
                        deco: ['Zen Maru Gothic', 'sans-serif'], 
                        heiti: ['Noto Sans SC', 'Heiti SC', 'SimHei', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        html, body {
            height: 100%;
            height: 100dvh;
            overflow: hidden;
            overscroll-behavior: none;
            background-color: #0F172A;
            color: #FFFFFF;
        }
        
        #app {
            height: 100%;
            height: 100dvh;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .animate-spin-slow { animation: spin 10s linear infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .shanghai-bg {
            background-color: #0F172A;
            background-image: 
                linear-gradient(to bottom, rgba(30, 27, 75, 0.2), rgba(15, 23, 42, 0.85)),
                url('https://images.unsplash.com/photo-1548266652-99cf27701ced?q=80&w=2670&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03); 
            backdrop-filter: blur(8px);            
            border: 1px solid rgba(255, 255, 255, 0.12); 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        
        .glass-nav {
            background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.6);
        }

        .glass-header {
            background: rgba(15, 23, 42, 0.15); 
            backdrop-filter: blur(6px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-deco {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .glass-modal {
            background: rgba(15, 23, 42, 0.85); 
            backdrop-filter: blur(25px);
        }

        .text-shadow-sm { text-shadow: 0 1px 3px rgba(0,0,0,0.6); }
        
        /* SortableJS Styling */
        .sortable-ghost { opacity: 0.2; }
        .sortable-drag { 
            cursor: grabbing; 
            background: rgba(255,255,255,0.15) !important; 
            transform: scale(1.03); 
            opacity: 1 !important; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 100;
        }

        /* Loader */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-left-color: #FF7EE2; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app" class="font-sans font-medium text-scheme1-textMain relative">
        <div class="w-full max-w-md h-full relative shadow-2xl flex flex-col overflow-hidden bg-transparent">
            
            <div class="absolute inset-0 z-0 shanghai-bg pointer-events-none"></div>

            <header class="glass-header text-white p-3 pt-5 pb-2 shadow-sm z-10 flex justify-between items-center relative flex-shrink-0">
                <div class="relative z-10 flex flex-col justify-center h-full w-full pl-2">
                    <h2 class="text-xs tracking-widest opacity-90 text-scheme1-secondary mb-0.5 font-sans font-bold uppercase drop-shadow-md">Wayne & Chloe | Shanghai 2025</h2>
                    <h1 class="text-2xl font-deco tracking-widest text-white drop-shadow-lg font-medium mt-0">
                        {{ myData.title || 'ËºâÂÖ•‰∏≠...' }}
                    </h1>
                </div>
                <div class="w-9 h-9 glass-card rounded-full flex items-center justify-center shadow-inner flex-shrink-0 mr-2 border border-white/30">
                    <div v-if="isLoading" class="loader"></div>
                    <i v-else class="fa-solid fa-plane text-scheme1-secondary text-sm animate-bounce rotate-90"></i>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto scrollbar-hide p-4 pb-24 space-y-5 relative z-10">
                
                <div v-if="currentTab === 'flight' && myData.flightOut" class="animate-fade-in space-y-4">
                    <h3 class="font-bold text-xl pl-3 border-l-4 border-scheme1-primary text-white text-shadow-sm font-deco tracking-wide">‚úàÔ∏è Ëà™Áè≠Ë≥áË®ä</h3>
                    
                    <div class="glass-card rounded-2xl p-4 relative overflow-hidden group">
                        <div class="absolute top-3 left-3 bg-scheme1-primary/20 border border-scheme1-primary/80 text-scheme1-primary text-xs px-2.5 py-0.5 rounded-full font-bold tracking-widest">ÂéªÁ®ã OUTBOUND</div>
                        <div class="mt-8 flex justify-between items-center mb-4">
                            <div class="text-center w-1/3"><div class="text-5xl font-black text-white tracking-tighter drop-shadow-lg font-heiti">{{ myData.flightOut.from }}</div><div class="text-sm text-scheme1-accent font-bold mt-1 tracking-wide">È¶ôÊ∏Ø T1</div></div>
                            <div class="flex-1 px-2 text-center flex flex-col items-center"><div class="text-xs text-scheme1-primary font-bold">{{ myData.flightOut.airline }}</div><i class="fa-solid fa-plane text-white text-xl block my-1 drop-shadow-md"></i><div class="border-b-2 border-dotted border-white/40 w-full h-1"></div><div class="text-xs text-scheme1-textSub mt-1 font-bold">{{ myData.flightOut.no }}</div></div>
                            <div class="text-center w-1/3"><div class="text-5xl font-black text-white tracking-tighter drop-shadow-lg font-heiti">{{ myData.flightOut.to }}</div><div class="text-sm text-scheme1-accent font-bold mt-1 tracking-wide">‰∏äÊµ∑Êµ¶Êù± T1</div></div>
                        </div>
                        <div class="bg-white/5 rounded-xl p-3 flex justify-between items-start text-sm border border-white/20">
                            <div><span class="text-xs text-scheme1-textSub/80 font-bold block">Date</span>{{ myData.flightOut.date }}</div>
                            <div class="flex gap-4">
                                <div class="text-right"><span class="text-xs text-scheme1-textSub/80 font-bold block">Dep</span><span class="font-bold text-scheme1-primary text-xl">{{ myData.flightOut.dep }}</span></div>
                                <div class="text-right"><span class="text-xs text-scheme1-textSub/80 font-bold block">Arr</span><span class="font-bold text-scheme1-primary text-xl">{{ myData.flightOut.arr }}</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-4 relative overflow-hidden group">
                        <div class="absolute top-3 left-3 bg-scheme1-secondary/20 border border-scheme1-secondary/80 text-scheme1-secondary text-xs px-2.5 py-0.5 rounded-full font-bold tracking-widest">ÂõûÁ®ã INBOUND</div>
                        <div class="mt-8 flex justify-between items-center mb-4">
                            <div class="text-center w-1/3"><div class="text-5xl font-black text-white tracking-tighter drop-shadow-lg font-heiti">{{ myData.flightIn.from }}</div><div class="text-sm text-scheme1-accent font-bold mt-1 tracking-wide">‰∏äÊµ∑Êµ¶Êù± T1</div></div>
                            <div class="flex-1 px-2 text-center flex flex-col items-center"><div class="text-xs text-scheme1-secondary font-bold">{{ myData.flightIn.airline }}</div><i class="fa-solid fa-plane text-white text-xl block my-1 rotate-180 drop-shadow-md"></i><div class="border-b-2 border-dotted border-white/40 w-full h-1"></div><div class="text-xs text-scheme1-textSub mt-1 font-bold">{{ myData.flightIn.no }}</div></div>
                            <div class="text-center w-1/3"><div class="text-5xl font-black text-white tracking-tighter drop-shadow-lg font-heiti">{{ myData.flightIn.to }}</div><div class="text-sm text-scheme1-accent font-bold mt-1 tracking-wide">È¶ôÊ∏Ø T1</div></div>
                        </div>
                        <div class="bg-white/5 rounded-xl p-3 flex justify-between items-start text-sm border border-white/20">
                            <div><span class="text-xs text-scheme1-textSub/80 font-bold block">Date</span>{{ myData.flightIn.date }}</div>
                            <div class="flex gap-4">
                                <div class="text-right"><span class="text-xs text-scheme1-textSub/80 font-bold block">Dep</span><span class="font-bold text-scheme1-secondary text-xl">{{ myData.flightIn.dep }}</span></div>
                                <div class="text-right"><span class="text-xs text-scheme1-textSub/80 font-bold block">Arr</span><span class="font-bold text-scheme1-secondary text-xl">{{ myData.flightIn.arr }}</span><span class="text-[10px] text-scheme1-primary block mt-0.5 font-bold">+1 Day</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'schedule' && myData.days" class="animate-fade-in space-y-4">
                    
                    <div class="grid grid-cols-4 gap-2 px-1">
                        <button v-for="(day, index) in myData.days" :key="index" @click="currentDayIndex = index" 
                            :class="currentDayIndex === index ? 'bg-scheme1-primary/90 text-white shadow-[0_0_15px_rgba(255,126,226,0.6)] border-transparent scale-105' : 'glass-card text-white/80 border-white/20'"
                            class="py-2 rounded-xl flex flex-col items-center justify-center transition-all duration-300 backdrop-blur-sm h-full">
                            <div class="flex flex-col items-center leading-none text-white w-full gap-0.5">
                                <span class="text-[10px] uppercase tracking-wider font-bold opacity-80 scale-90 mb-0.5">DAY {{ index + 1 }}</span>
                                <span class="text-3xl font-black drop-shadow-sm -my-1">{{ day.dayNum }}</span>
                                <span class="text-[10px] font-bold opacity-80 scale-90 mt-0.5">{{ day.weekday }}</span>
                            </div>
                        </button>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-4 text-white flex items-center justify-between opacity-90 pl-1 text-shadow-sm">
                            <div><span class="text-scheme1-primary mr-2"><i class="fa-solid fa-calendar-day"></i></span>{{ myData.days[currentDayIndex].date }}</div>
                            <span class="text-[10px] bg-white/10 px-2 py-1 rounded text-gray-300"><i class="fa-solid fa-hand-pointer mr-1"></i>Êåâ‰ΩèÊãñÊõ≥</span>
                        </h3>
                        
                        <div class="relative pl-4">
                            <div class="absolute left-[3.5px] top-2 bottom-0 w-[2px] bg-white/20 rounded-full"></div>
                            
                            <div ref="sortableList" class="space-y-3 pb-24">
                                <div v-for="(item, idx) in myData.days[currentDayIndex].events" :key="item.id" 
                                     @click="openEditModal(idx)"
                                     class="relative group select-none transition-transform duration-200 cursor-pointer">
                                    
                                    <div class="absolute -left-[17px] top-3 w-3 h-3 bg-scheme1-bg border-[3px] border-scheme1-primary rounded-full z-10 shadow-sm"></div>
                                    
                                    <div class="glass-card rounded-xl p-0 transition-all duration-300 relative overflow-hidden z-0 hover:bg-white/10 hover:border-scheme1-primary/40">
                                        
                                        <div v-if="item.img" class="h-24 w-full relative overflow-hidden">
                                            <img :src="item.img" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-90 select-none pointer-events-none">
                                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/30 to-transparent"></div>
                                            <div class="absolute bottom-2 left-3 right-3 flex justify-between items-end z-10">
                                                <div class="flex items-center gap-2">
                                                    <span class="bg-scheme1-primary text-white font-bold text-sm px-2 py-0.5 rounded shadow-[0_0_10px_#FF7EE2] select-none">{{ item.time }}</span>
                                                    <div class="flex items-center text-white text-xs gap-1 font-bold select-none" v-if="item.weather">
                                                        <i :class="getWeatherIcon(item.weather)"></i><span>{{ item.temp }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div v-else class="p-3 pb-0 flex justify-between items-center mb-1">
                                            <span class="bg-scheme1-primary/20 text-scheme1-primary font-bold text-sm px-2.5 py-0.5 rounded-full border border-scheme1-primary/30 shadow-[0_0_10px_rgba(255,126,226,0.4)] select-none">{{ item.time }}</span>
                                            <div class="flex items-center text-scheme1-textSub text-xs gap-1.5 font-bold select-none" v-if="item.weather">
                                                <i :class="getWeatherIcon(item.weather)"></i><span>{{ item.temp }}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="p-3 pt-1 relative">
                                            <h4 class="font-bold text-base text-white mb-0.5 drop-shadow-md select-none">{{ item.title }}</h4>
                                            
                                            <p class="text-xs text-scheme1-textSub/90 mb-0.5 leading-snug font-bold line-clamp-2 select-none pointer-events-none">{{ item.desc }}</p>
                                            
                                            <div class="flex justify-between items-end mt-0.5">
                                                <p v-if="item.location" class="text-sm text-scheme1-secondary flex-1 mr-2 leading-tight select-text cursor-text z-20" @click.stop><i class="fa-solid fa-location-dot mr-1 text-xs drop-shadow-[0_0_5px_rgba(34,211,238,1)] select-none"></i>{{ item.location }}</p>
                                                
                                                <a :href="'https://www.google.com/maps/search/?api=1&query=' + item.location" target="_blank" @click.stop class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-scheme1-secondary hover:bg-scheme1-secondary hover:text-white transition-colors shadow-sm border border-white/20 flex-shrink-0 select-none z-20">
                                                    <i class="fa-solid fa-diamond-turn-right text-sm"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button @click="openAddModal" class="w-full py-3 mt-4 mb-4 rounded-xl border-2 border-dashed border-scheme1-primary/30 text-scheme1-primary/70 hover:bg-scheme1-primary/10 hover:border-scheme1-primary hover:text-scheme1-primary transition-all font-bold flex items-center justify-center gap-2">
                                <i class="fa-solid fa-plus"></i> Êñ∞Â¢ûË°åÁ®ã
                            </button>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'map'" class="animate-fade-in h-full flex flex-col items-center justify-center pt-10 pb-20">
                    <div class="glass-card p-6 rounded-3xl mb-6 animate-bounce relative backdrop-blur-xl border border-scheme1-primary/40 shadow-[0_0_30px_rgba(255,126,226,0.3)]">
                         <div class="absolute inset-0 bg-scheme1-primary/10 rounded-3xl blur-xl -z-10"></div>
                        <i class="fa-solid fa-map-location-dot text-7xl text-scheme1-primary drop-shadow-[0_0_15px_rgba(255,126,226,0.6)]"></i>
                    </div>
                    <h3 class="font-bold text-2xl text-white mb-2 drop-shadow-sm text-shadow-sm font-deco tracking-widest">üó∫Ô∏è Êé¢Á¥¢‰∏äÊµ∑</h3>
                    <p class="text-scheme1-textSub text-base text-center leading-relaxed font-bold">ÈªûÊìäË°åÁ®ã‰∏≠ÁöÑÂú∞Èªû<br>ÈñãÂïü Google Maps Â∞éËà™</p>
                </div>

                <div v-if="currentTab === 'shops' && myData.shops" class="animate-fade-in pb-20">
                    <h3 class="font-bold text-xl mb-4 pl-3 border-l-4 border-scheme1-primary text-white opacity-90 text-shadow-sm font-deco tracking-wide">üõçÔ∏è ÂøÖÈÄõÂ∫óËàñ & ÁæéÈ£ü</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div v-for="(shop, idx) in myData.shops" :key="idx" 
                             @click="openShopDetails(shop)"
                             class="glass-card rounded-2xl p-4 flex flex-col items-center justify-center text-center relative overflow-hidden group hover:border-scheme1-primary/50 transition-colors select-none cursor-pointer aspect-square">
                            
                            <div :class="getShopIconColor(shop.color)" class="w-10 h-10 rounded-full bg-white/5 border border-white/20 flex items-center justify-center text-lg shadow-inner mb-2 group-hover:scale-110 transition-transform">
                                <i :class="['fa-solid', getShopCategoryIcon(shop.type)]"></i>
                            </div>
                            
                            <div class="mb-2 w-full">
                                <h4 class="font-bold text-white text-base leading-tight drop-shadow-sm">
                                    {{ getShopNameParts(shop.name).main }}
                                </h4>
                                <p v-if="getShopNameParts(shop.name).sub" class="text-xs text-scheme1-textSub/90 mt-0.5">
                                    {{ getShopNameParts(shop.name).sub }}
                                </p>
                            </div>

                            <div class="flex items-center justify-center text-[10px] text-scheme1-secondary font-bold bg-white/5 px-2 py-1 rounded-full mb-2 w-full">
                                <i class="fa-solid fa-clock mr-1.5"></i>
                                <span class="truncate">{{ getSimpleHours(shop.hours) }}</span>
                            </div>
                            
                            <span v-if="shop.tag" class="text-[10px] bg-scheme1-primary/10 text-scheme1-primary px-2 py-0.5 rounded-full border border-scheme1-primary/20 font-bold">{{ shop.tag }}</span>
                        </div>
                    </div>
                    
                    <button @click="openAddShopModal" class="w-full py-3 mt-6 rounded-xl border-2 border-dashed border-scheme1-primary/30 text-scheme1-primary/70 hover:bg-scheme1-primary/10 hover:border-scheme1-primary hover:text-scheme1-primary transition-all font-bold flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> Êñ∞Â¢ûÂ∫óËàñ
                    </button>
                </div>

                <div v-if="currentTab === 'hotel' && myData.hotel" class="animate-fade-in space-y-4">
                    <h3 class="font-bold text-xl pl-3 border-l-4 border-scheme1-secondary text-white opacity-90 text-shadow-sm font-deco tracking-wide">üè® ‰ΩèÂÆøË≥áË®ä</h3>
                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div class="h-48 relative flex items-end overflow-hidden group">
                            <img :src="myData.hotel.image" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-70" alt="Hotel Room">
                            <div class="absolute inset-0 bg-gradient-to-t from-scheme1-bg via-scheme1-bg/40 to-transparent"></div>
                            
                            <div class="absolute top-3 right-3 bg-black/40 backdrop-blur-md text-white/90 text-xs font-bold px-3 py-1 rounded-full shadow-lg border border-white/10 select-none z-20">
                                4Êôö ‚ú®
                            </div>

                            <div class="relative z-10 p-5 w-full text-white">
                                <h2 class="text-2xl font-black leading-tight mb-1 text-white shadow-sm text-shadow-sm">{{ myData.hotel.name }}</h2>
                                <p class="text-sm text-white/90 font-bold truncate">{{ myData.hotel.engName }}</p>
                            </div>
                        </div>
                        <div class="p-5">
                            <div class="bg-white/5 rounded-xl p-3 mb-4 flex items-start border border-white/10">
                                <i class="fa-solid fa-location-dot text-scheme1-secondary mt-1 mr-2.5 text-lg drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]"></i>
                                <div class="flex-1">
                                    <p class="text-base text-white font-bold mb-1 leading-snug">{{ myData.hotel.address }}</p>
                                    <a :href="'https://www.google.com/maps/search/?api=1&query=' + myData.hotel.name" target="_blank" class="text-xs text-scheme1-primary font-bold flex items-center gap-1 hover:underline">
                                        ÈñãÂïü Google Maps <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 text-center">
                                <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                                    <div class="text-xs text-scheme1-textSub mb-1 uppercase tracking-wide font-black">Check-in</div>
                                    <div class="font-bold text-scheme1-primary text-xl">14:00</div>
                                    <div class="text-xs text-scheme1-textSub mt-1 font-bold">{{ myData.hotel.checkIn }}</div>
                                </div>
                                <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                                    <div class="text-xs text-scheme1-textSub mb-1 uppercase tracking-wide font-black">Check-out</div>
                                    <div class="font-bold text-scheme1-secondary text-xl">12:00</div>
                                    <div class="text-xs text-scheme1-textSub mt-1 font-bold">{{ myData.hotel.checkOut }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>

            <nav class="glass-nav h-16 px-1 flex justify-evenly items-center z-50 rounded-t-[2rem] pb-1 relative flex-shrink-0">
                <button @click="currentTab = 'flight'" :class="currentTab === 'flight' ? 'text-scheme1-primary drop-shadow-[0_0_8px_rgba(255,126,226,0.8)]' : 'text-scheme1-textSub/40 hover:text-scheme1-textSub'" class="flex flex-col items-center w-14 transition-colors">
                    <i class="fa-solid fa-plane-departure text-2xl mb-0.5"></i><span class="text-[10px] tracking-wide font-bold">Ëà™Áè≠</span>
                </button>
                <button @click="currentTab = 'schedule'" :class="currentTab === 'schedule' ? 'text-scheme1-primary drop-shadow-[0_0_8px_rgba(255,126,226,0.8)]' : 'text-scheme1-textSub/40 hover:text-scheme1-textSub'" class="flex flex-col items-center w-14 transition-colors">
                    <i class="fa-solid fa-clipboard-list text-2xl mb-0.5"></i><span class="text-[10px] tracking-wide font-bold">Ë°åÁ®ã</span>
                </button>
                <div class="-mt-8 relative z-10">
                    <button @click="currentTab = 'map'" class="bg-scheme1-bg text-scheme1-primary w-14 h-14 rounded-full shadow-[0_0_20px_rgba(255,126,226,0.4)] border-2 border-scheme1-primary/50 flex items-center justify-center backdrop-blur-sm transform active:scale-95 transition-all">
                        <i class="fa-solid fa-map text-3xl animate-pulse drop-shadow-[0_0_5px_rgba(255,126,226,1)]"></i>
                    </button>
                </div>
                <button @click="currentTab = 'shops'" :class="currentTab === 'shops' ? 'text-scheme1-primary drop-shadow-[0_0_8px_rgba(255,126,226,0.8)]' : 'text-scheme1-textSub/40 hover:text-scheme1-textSub'" class="flex flex-col items-center w-14 transition-colors">
                    <i class="fa-solid fa-store text-2xl mb-0.5"></i><span class="text-[10px] tracking-wide font-bold">Â∫óËàñ</span>
                </button>
                <button @click="currentTab = 'hotel'" :class="currentTab === 'hotel' ? 'text-scheme1-primary drop-shadow-[0_0_8px_rgba(255,126,226,0.8)]' : 'text-scheme1-textSub/40 hover:text-scheme1-textSub'" class="flex flex-col items-center w-14 transition-colors">
                    <i class="fa-solid fa-bed text-2xl mb-0.5"></i><span class="text-[10px] tracking-wide font-bold">‰ΩèÂÆø</span>
                </button>
            </nav>

            <div v-if="showShopModal && selectedShop" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in glass-modal" @click.self="closeShopModal">
                <div class="glass-card w-full max-w-sm rounded-3xl p-6 relative flex flex-col shadow-2xl border border-scheme1-primary/40">
                    <button @click="closeShopModal" class="absolute top-4 right-4 text-white/60 hover:text-white transition-colors z-10"><i class="fa-solid fa-xmark text-xl"></i></button>
                    
                    <div class="flex flex-col items-center text-center mb-6">
                        <div :class="getShopIconColor(selectedShop.color)" class="w-16 h-16 rounded-full bg-white/5 border border-white/20 flex items-center justify-center text-3xl shadow-[0_0_15px_rgba(255,255,255,0.1)] mb-3">
                             <i :class="['fa-solid', getShopCategoryIcon(selectedShop.type)]"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white font-deco tracking-wide select-text cursor-text">{{ selectedShop.name }}</h3>
                        <span v-if="selectedShop.tag" class="mt-2 text-xs bg-scheme1-primary/20 text-scheme1-primary px-3 py-0.5 rounded-full border border-scheme1-primary/30 font-bold select-none">{{ selectedShop.tag }}</span>
                    </div>

                    <div class="space-y-4 text-sm flex-1 overflow-y-auto scrollbar-hide">
                        <div class="bg-white/5 rounded-xl p-3 border border-white/10 select-text cursor-text"><label class="text-[10px] text-scheme1-secondary uppercase font-bold block mb-1 select-none">Âú∞ÂùÄ</label><p class="text-white leading-relaxed"><i class="fa-solid fa-location-dot mr-2 text-scheme1-secondary select-none"></i>{{ selectedShop.address }}</p></div>
                        <div class="bg-white/5 rounded-xl p-3 border border-white/10 select-none"><label class="text-[10px] text-scheme1-secondary uppercase font-bold block mb-1">ÁáüÊ•≠ÊôÇÈñì</label><div class="text-white"><i class="fa-solid fa-clock mr-2 text-scheme1-secondary float-left mt-1"></i><div class="overflow-hidden"><div v-for="(line, idx) in selectedShop.hours.split('|')" :key="idx" class="block">{{ line.trim() }}</div></div></div></div>
                        <div class="bg-white/5 rounded-xl p-3 border border-white/10 select-none" v-if="selectedShop.transport"><label class="text-[10px] text-scheme1-secondary uppercase font-bold block mb-1">‰∫§ÈÄöÊñπÂºè</label><p class="text-white"><i class="fa-solid fa-train-subway mr-2 text-scheme1-secondary"></i>{{ selectedShop.transport }}</p></div>
                    </div>
                    
                    <div class="flex gap-2 mt-6">
                         <button @click="deleteShop(selectedShop)" class="px-4 py-3 rounded-xl border border-red-500/50 text-red-400 hover:bg-red-500/20 font-bold select-none"><i class="fa-solid fa-trash"></i></button>
                         <a :href="'https://www.google.com/maps/search/?api=1&query=' + selectedShop.address" target="_blank" class="flex-1 py-3 rounded-xl bg-scheme1-primary text-scheme1-bg hover:bg-scheme1-primary/90 transition-colors font-bold shadow-lg flex items-center justify-center gap-2 select-none"><i class="fa-solid fa-map-location-dot"></i> ÈñãÂïü Google Maps</a>
                    </div>
                </div>
            </div>

            <div v-if="showAddShopModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in glass-modal">
                <div class="glass-card w-full max-w-sm rounded-3xl p-6 relative flex flex-col max-h-[90vh] overflow-hidden border border-scheme1-primary/50">
                    <h3 class="text-2xl font-bold text-center mb-4 text-white font-deco tracking-widest">Êñ∞Â¢ûÂ∫óËàñ</h3>
                    <div class="overflow-y-auto space-y-4 pr-1 scrollbar-hide flex-1">
                        <div><label class="text-xs text-scheme1-secondary font-bold uppercase">Â∫óÂêç</label><input v-model="shopFormData.name" type="text" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white focus:border-scheme1-primary outline-none mt-1"></div>
                        <div>
                             <label class="text-xs text-scheme1-secondary font-bold uppercase">Á®ÆÈ°û</label>
                             <select v-model="shopFormData.type" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white focus:border-scheme1-primary outline-none mt-1">
                                 <option class="text-black" value="Cafe">Cafe</option>
                                 <option class="text-black" value="È§êÂª≥">È§êÂª≥</option>
                                 <option class="text-black" value="Èõ∂ÂîÆ">Èõ∂ÂîÆ</option>
                             </select>
                        </div>
                        <div><label class="text-xs text-scheme1-secondary font-bold uppercase">Âú∞ÂùÄ</label><input v-model="shopFormData.address" type="text" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white focus:border-scheme1-primary outline-none mt-1"></div>
                        <div>
                             <label class="text-xs text-scheme1-secondary font-bold uppercase">ÁáüÊ•≠ÊôÇÈñì</label>
                             <select v-model="shopFormData.hours" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white focus:border-scheme1-primary outline-none mt-1">
                                 <option class="text-black" value="10:00 - 22:00">10:00 - 22:00</option>
                                 <option class="text-black" value="09:00 - 21:00">09:00 - 21:00</option>
                                 <option class="text-black" value="11:00 - 23:00">11:00 - 23:00</option>
                                 <option class="text-black" value="24Â∞èÊôÇ">24Â∞èÊôÇ</option>
                                 <option class="text-black" value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ (Ë´ãÂú®ÂÇôË®ªÂ°´ÂØ´)</option>
                             </select>
                        </div>
                        <div><label class="text-xs text-scheme1-secondary font-bold uppercase">‰∫§ÈÄöÊñπÂºè</label><input v-model="shopFormData.transport" type="text" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white focus:border-scheme1-primary outline-none mt-1"></div>
                    </div>
                    <div class="flex gap-3 mt-6 pt-4 border-t border-white/10">
                        <button @click="showAddShopModal = false" class="flex-1 py-2.5 rounded-xl border border-white/30 text-white hover:bg-white/10 transition-colors font-bold">ÂèñÊ∂à</button>
                        <button @click="saveShop" class="flex-1 py-2.5 rounded-xl bg-scheme1-primary text-scheme1-bg hover:bg-scheme1-primary/90 transition-colors font-bold shadow-sm">ÂÑ≤Â≠ò</button>
                    </div>
                </div>
            </div>

            <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in glass-modal">
                <div class="glass-card w-full max-w-sm rounded-3xl p-6 relative flex flex-col max-h-[90vh] overflow-hidden border border-scheme1-primary/50">
                    <button v-if="isEditing" @click="deleteEvent" class="absolute top-6 left-6 text-white/50 hover:text-red-500 transition-colors z-10"><i class="fa-solid fa-trash"></i></button>

                    <h3 class="text-2xl font-bold text-center mb-4 text-white font-deco tracking-widest">{{ isEditing ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}</h3>
                    <div class="overflow-y-auto space-y-4 pr-1 scrollbar-hide flex-1">
                        <div><label class="text-xs text-scheme1-secondary font-bold uppercase">ÊôÇÈñì (24h)</label><input v-model="modalData.time" type="text" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white focus:border-scheme1-primary outline-none mt-1"></div>
                        <div><label class="text-xs text-scheme1-secondary font-bold uppercase">Ê®ôÈ°å</label><input v-model="modalData.title" type="text" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white focus:border-scheme1-primary outline-none mt-1"></div>
                        <div><label class="text-xs text-scheme1-secondary font-bold uppercase">ÊèèËø∞</label><textarea v-model="modalData.desc" rows="3" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white focus:border-scheme1-primary outline-none mt-1 resize-none scrollbar-hide"></textarea></div>
                        <div><label class="text-xs text-scheme1-secondary font-bold uppercase">Âú∞Èªû/Âú∞ÂùÄ</label><input v-model="modalData.location" type="text" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white focus:border-scheme1-primary outline-none mt-1"></div>
                         <div>
                            <label class="text-xs text-scheme1-secondary font-bold uppercase">ÂúñÁâá (‰∏äÂÇ≥ÊàñURL)</label>
                            <input type="file" @change="handleFileUpload" accept="image/*" class="w-full mt-1 text-xs text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-scheme1-primary/20 file:text-white hover:file:bg-scheme1-primary/40 mb-2">
                            <div v-if="isUploading" class="text-xs text-scheme1-primary font-bold animate-pulse">Ê≠£Âú®Â£ìÁ∏Æ‰∏¶‰∏äÂÇ≥ÂúñÁâá...</div>
                            <input v-model="modalData.img" type="text" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white focus:border-scheme1-primary outline-none mt-1" placeholder="ÊàñË≤º‰∏äÂúñÁâá URL...">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6 pt-4 border-t border-white/10">
                        <button @click="closeModal" class="flex-1 py-2.5 rounded-xl border border-white/30 text-white hover:bg-white/10 transition-colors font-bold">ÂèñÊ∂à</button>
                        <button @click="saveEvent" class="flex-1 py-2.5 rounded-xl bg-scheme1-primary text-scheme1-bg hover:bg-scheme1-primary/90 transition-colors font-bold shadow-sm" :disabled="isUploading">{{ isEditing ? 'ÂÑ≤Â≠òËÆäÊõ¥' : 'Êñ∞Â¢û' }}</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { createApp, ref, onMounted, nextTick, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, onSnapshot, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // „ÄêÂú®Ê≠§Â°´ÂÖ•ÊÇ®ÁöÑ Firebase Config„Äë
        const firebaseConfig = {
             apiKey: "YOUR_API_KEY",
             authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
             projectId: "YOUR_PROJECT_ID",
             storageBucket: "YOUR_PROJECT_ID.appspot.com",
             messagingSenderId: "...",
             appId: "..."
        };

        let db = null;
        let storage = null;
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            storage = getStorage(app);
            enableIndexedDbPersistence(db).catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log('Multiple tabs open, persistence can only be enabled in one tab at a a time.');
                } else if (err.code == 'unimplemented') {
                    console.log('The current browser does not support all of the features required to enable persistence');
                }
            });
        } catch (e) {
            console.error("Firebase Init Error (Check Config):", e);
        }

        const defaultData = {
            title: "üéÑ ËÅñË™ï‰∏äÊµ∑‰πãÊóÖ 2025", 
            shops: [
                { name: "‰∏ÄÂ∞∫Ëä±ÂúíÔºàÂª£ÂØåÊûóÂ∫óÔºâ", type: "Cafe", tag: "Âè§ÂÆÖËä±Âúí", address: "ÊùæÊ±üÂçÄÂª£ÂØåÊûóË∑Ø3088ÂºÑ3ËôüÈõÜË≥¢Âùä01-03Ê£ü", hours: "10:00 - 22:00", transport: "Â∑¥Â£´ÊùæÊ±ü98Ë∑Ø / ÊùæÊ±ü15Ë∑Ø (Âª£ÂØåÊûóË∑ØÈæçÊ∫êË∑ØÁ´ô) ‰∏ãËªäÊ≠•Ë°å5ÂàÜÈêò", color: "text-green-400" },
                { name: "wabi cofeÔºàÊÑöÂúíË∑ØÂ∫óÔºâ", type: "Cafe", tag: "Êó•ÂºèÂ∫≠Èô¢", address: "Èï∑ÂØßÂçÄÊÑöÂúíË∑Ø1327Ëôü", hours: "10:30 - 00:00", transport: "Âú∞Èêµ‰∏≠Â±±ÂÖ¨ÂúíÁ´ô 8ËôüÂá∫Âè£", color: "text-yellow-600" },
                { name: "LCH Caf√©", type: "Cafe", tag: "Âæ©Âè§È¢®", address: "‰∏äÊµ∑Â∏ÇÈªÉÊµ¶ÂçÄÂçóÊòåË∑Ø274Ëôü-1Ëôü", hours: "10:00-18:00 | 10:00-19:00", transport: "Âú∞ÈêµÈôùË•øÂçóË∑ØÁ´ô (1/10/12ËôüÁ∑ö)", color: "text-pink-400" }
            ],
            hotel: { name: "‰∏äÊµ∑Êù±Èå¶Ê±üÂ∏åÁàæÈ†ìÈÄ∏ÊûóÈÖíÂ∫ó", engName: "DoubleTree by Hilton Shanghai - Pudong", address: "‰∏äÊµ∑Â∏ÇÊµ¶Êù±Êñ∞ÂçÄÊù±ÊñπË∑Ø889Ëôü", checkIn: "12Êúà23Êó• (‰∫å)", checkOut: "12Êúà26Êó• (‰∫î)", image: "https://images.unsplash.com/photo-1590490360182-c33d57733427?q=80&w=1000&auto=format&fit=crop" },
            flightOut: { from: "HKG", to: "PVG", date: "2025/12/23 (‰∫å)", no: "MU726", dep: "07:40", arr: "10:30", airline: "‰∏≠ÂúãÊù±ÊñπËà™Á©∫" },
            flightIn: { from: "PVG", to: "HKG", date: "2025/12/26 (‰∫î)", no: "MU725", dep: "21:20", arr: "00:15", airline: "‰∏≠ÂúãÊù±ÊñπËà™Á©∫" },
            days: [
                { date: "12Êúà23Êó•", dateShort: "23 DEC", weekday: "(‰∫å)", dayNum: "23", events: [
                    { id: 1, time: "10:30", title: "ÊäµÈÅî‰∏äÊµ∑Êµ¶Êù± üõ¨", location: "‰∏äÊµ∑Â∏ÇÊµ¶Êù±Êñ∞ÂçÄÊµ¶Êù±ÂúãÈöõÊ©üÂ†¥ T1", desc: "ÂÖ•Â¢ÉÊâãÁ∫å„ÄÅÈ†òÂèñË°åÊùéÔºåÂâçÂæÄÈÖíÂ∫óCheck-in„ÄÇ", weather: "cloudy", temp: "8¬∞C" },
                    { id: 101, time: "12:30", title: "Ëæ¶ÁêÜÂÖ•‰Ωè üè®", location: "‰∏äÊµ∑Â∏ÇÊµ¶Êù±Êñ∞ÂçÄÊù±ÊñπË∑Ø889Ëôü", desc: "ÂâçÂæÄÊù±Èå¶Ê±üÂ∏åÁàæÈ†ìÈÄ∏ÊûóÈÖíÂ∫ó Check-in / ÂØÑÂ≠òË°åÊùé„ÄÇ", icon: "hotel" },
                    { id: 2, time: "15:00", title: "Êµ¶Êù±ÁæéË°ìÈ§® üé®", location: "‰∏äÊµ∑Â∏ÇÊµ¶Êù±Êñ∞ÂçÄÊø±Ê±üÂ§ßÈÅì2777Ëôü", desc: "Ê¨£Ë≥ûÂª∫ÁØâ‰πãÁæéÔºåÁ™óÂè£ÂèØÁõ¥Èù¢Â§ñÁÅòËê¨ÂúãÂª∫ÁØâÁæ§„ÄÇ", weather: "cloudy", temp: "9¬∞C" },
                    { id: 3, time: "18:00", title: "ÂçÅÂÖ≠Èã™Á¢ºÈ†≠ üåÉ", location: "‰∏äÊµ∑Â∏ÇÈªÉÊµ¶ÂçÄ‰∏≠Â±±Êù±‰∫åË∑Ø551Ëôü", desc: "Êº´Ê≠•Ê±üÈÇäÊàñÊê≠‰πòÈÅäËàπÔºåÊ¨£Ë≥ûÈªÉÊµ¶Ê±üÁíÄÁí®Â§úÊôØ„ÄÇ", weather: "clear", temp: "5¬∞C" }
                ]},
                { date: "12Êúà24Êó•", dateShort: "24 DEC", weekday: "(‰∏â)", dayNum: "24", events: [
                    { id: 4, time: "10:00", title: "Ë±´Âúí & ÂüéÈöçÂªü üßß", location: "‰∏äÊµ∑Â∏ÇÈªÉÊµ¶ÂçÄÁ¶è‰ΩëË∑Ø168Ëôü", desc: "Ê±üÂçóÂè§ÂÖ∏ÂúíÊûóËàáËÄÅ‰∏äÊµ∑Á•àÁ¶èÔºåÂìÅÂöêÂçóÁøîÂ∞èÁ±†ÂåÖ„ÄÇ", weather: "sunny", temp: "9¬∞C" },
                    { id: 5, time: "14:30", title: "Êñ∞Â§©Âú∞ÂåóÈáå üéÑ", location: "‰∏äÊµ∑Â∏ÇÈªÉÊµ¶ÂçÄÂ§™ÂÄâË∑Ø181Ëôü", desc: "Âπ≥ÂÆâÂ§úÈÄõË°óÔºåÁü≥Â∫´ÈñÄÂª∫ÁØâËàáÁèæ‰ª£ËÅñË™ïË£ùÈ£æÂÆåÁæéËûçÂêà„ÄÇ", weather: "sunny", temp: "10¬∞C" },
                    { id: 6, time: "19:00", title: "Âπ≥ÂÆâÂ§úÊôöÈ§ê üç∑", location: "‰∏äÊµ∑Â∏ÇÈªÉÊµ¶ÂçÄÊñ∞Â§©Âú∞ÂåóÈáå", desc: "Âú®ÂÖÖÊªøÁØÄÊó•Ê∞£Ê∞õÁöÑÈ§êÂª≥‰∫´Áî®ËÅñË™ïÂ§ßÈ§ê„ÄÇ", weather: "clear", temp: "6¬∞C" }
                ]},
                { date: "12Êúà25Êó•", dateShort: "25 DEC", weekday: "(Âõõ)", dayNum: "25", events: [
                    { id: 7, time: "10:00", title: "Êú±ÂÆ∂ËßíÂè§ÈéÆ üõ∂", location: "‰∏äÊµ∑Â∏ÇÈùíÊµ¶ÂçÄÊú±ÂÆ∂ËßíÂè§ÈéÆË™≤Ê§çÂúíË∑Ø", desc: "‰∏äÊµ∑Â®ÅÂ∞ºÊñØÔºå‰πòÊâãÊêñËàπÈÅäË¶ΩÊîæÁîüÊ©ãËàáÂè§Â∑∑(ÂÖ®Êó•Ë°åÁ®ã)„ÄÇ", weather: "sunny", temp: "11¬∞C" },
                    { id: 8, time: "17:00", title: "ËøîÂõûÂ∏ÇÂçÄ üöå", location: "‰∏äÊµ∑Â∏ÇÈªÉÊµ¶ÂçÄ‰∫∫Ê∞ëÂª£Â†¥", desc: "Êê≠‰πòÂú∞Èêµ17ËôüÁ∑öËøîÂõûÂ∏ÇÂçÄ‰ºëÊÅØ„ÄÇ", weather: "clear", temp: "7¬∞C" }
                ]},
                { date: "12Êúà26Êó•", dateShort: "26 DEC", weekday: "(‰∫î)", dayNum: "26", events: [
                    { id: 102, time: "10:00", title: "Ëæ¶ÁêÜÈÄÄÊàø üëã", location: "‰∏äÊµ∑Â∏ÇÊµ¶Êù±Êñ∞ÂçÄÊù±ÊñπË∑Ø889Ëôü", desc: "Check-out ‰∏¶ÂØÑÂ≠òË°åÊùéÔºåÈñãÂßãÊúÄÂæå‰∏ÄÂ§©Ë°åÁ®ã„ÄÇ", icon: "suitcase" },
                    { id: 9, time: "10:30", title: "Ê≠¶Â∫∑Ë∑Ø City Walk üçÇ", location: "‰∏äÊµ∑Â∏ÇÂæêÂåØÂçÄÊ≠¶Â∫∑Ë∑Ø", desc: "ÊâìÂç°Ê≠¶Â∫∑Â§ßÊ®ì(Ê∑ÆÊµ∑‰∏≠Ë∑Ø1850Ëôü)ÔºåÊÑüÂèóÊ≥ïÁßüÁïåÊ¢ßÊ°êÊ®π‰∏ãÁöÑÊµ™Êº´„ÄÇ", weather: "cloudy", temp: "8¬∞C" },
                    { id: 10, time: "14:00", title: "Áî∞Â≠êÂùä üõçÔ∏è", location: "‰∏äÊµ∑Â∏ÇÈªÉÊµ¶ÂçÄÊ≥∞Â∫∑Ë∑Ø210Ëôü", desc: "Á©øÊ¢≠ËÄÅÂºÑÂ†ÇÔºåË≥ºË≤∑ÁâπËâ≤ÊñáÂâµËàá‰º¥ÊâãÁ¶Æ„ÄÇ", weather: "cloudy", temp: "9¬∞C" },
                    { id: 11, time: "17:30", title: "ÂâçÂæÄÊ©üÂ†¥ üöï", location: "‰∏äÊµ∑Â∏ÇÊµ¶Êù±Êñ∞ÂçÄÊµ¶Êù±ÂúãÈöõÊ©üÂ†¥ T1", desc: "È†êÁïôÊôÇÈñìÂâçÂæÄÊ©üÂ†¥ÔºåÊ∫ñÂÇôÊê≠‰πò21:20Ëà™Áè≠„ÄÇ", weather: "cloudy", temp: "7¬∞C" }
                ]}
            ]
        };

        createApp({
            setup() {
                const currentTab = ref('flight');
                const currentDayIndex = ref(0);
                const showModal = ref(false);
                const isEditing = ref(false);
                const editingEventIndex = ref(null);
                
                const showShopModal = ref(false);
                const showAddShopModal = ref(false);
                const selectedShop = ref(null);
                const shopFormData = ref({ name: '', type: 'Cafe', tag: '', address: '', hours: '10:00 - 22:00', transport: '' }); // tag (hidden in UI but kept in data structure), hours default

                const sortableList = ref(null);
                let sortableInstance = null;
                const isLoading = ref(true);
                const isUploading = ref(false);
                
                const myData = ref(defaultData); 
                const modalData = ref({ time: '', title: '', desc: '', location: '', img: '' });

                const initSync = () => {
                    if (!db) {
                        console.warn("Firestore not initialized, using local data.");
                        isLoading.value = false;
                        return;
                    }
                    const tripDocRef = doc(db, "trips", "shanghai2025");
                    onSnapshot(tripDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            myData.value = { ...defaultData, ...docSnap.data() };
                            if (!myData.value.days) myData.value.days = defaultData.days;
                        } else {
                            setDoc(tripDocRef, defaultData);
                        }
                        isLoading.value = false;
                        nextTick(() => { if(currentTab.value === 'schedule') initSortable(); });
                    }, (error) => { console.error("Sync Error:", error); isLoading.value = false; });
                };

                const updateTripData = () => {
                    if (!db) return;
                    const dataToSave = JSON.parse(JSON.stringify(myData.value));
                    setDoc(doc(db, "trips", "shanghai2025"), dataToSave).catch(e => console.error("Save Error:", e));
                };

                const handleFileUpload = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    if (!storage) { alert("Storage not configured."); return; }
                    isUploading.value = true;
                    try {
                        const compressedBlob = await compressImage(file);
                        const fileName = `images/${Date.now()}_${file.name}`;
                        const imgRef = storageRef(storage, fileName);
                        await uploadBytes(imgRef, compressedBlob);
                        const url = await getDownloadURL(imgRef);
                        modalData.value.img = url;
                    } catch (error) { console.error("Upload failed:", error); alert("ÂúñÁâá‰∏äÂÇ≥Â§±Êïó"); } finally { isUploading.value = false; }
                };

                const compressImage = (file) => {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.src = URL.createObjectURL(file);
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const maxWidth = 800; 
                            const scaleSize = maxWidth / img.width;
                            canvas.width = maxWidth;
                            canvas.height = img.height * scaleSize;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            canvas.toBlob((blob) => { if (blob) resolve(blob); else reject(new Error("Canvas blob error")); }, 'image/webp', 0.8);
                        };
                        img.onerror = (e) => reject(e);
                    });
                };

                const getWeatherIcon = (weather) => {
                    switch (weather) {
                        case 'sunny': return 'fa-solid fa-sun text-scheme1-accent';
                        case 'cloudy': return 'fa-solid fa-cloud text-scheme1-textSub';
                        case 'rainy': return 'fa-solid fa-cloud-rain text-scheme1-secondary';
                        case 'clear': return 'fa-solid fa-moon text-scheme1-accent';
                        default: return '';
                    }
                };
                
                const getShopIconColor = (colorClass) => {
                    if(colorClass) return colorClass;
                    return 'text-white';
                };

                // Updated: Icon logic based on TYPE
                const getShopCategoryIcon = (type) => {
                    if (type === 'Cafe') return 'fa-mug-hot';
                    if (type === 'È§êÂª≥') return 'fa-utensils';
                    if (type === 'Èõ∂ÂîÆ') return 'fa-bag-shopping';
                    return 'fa-store';
                };

                const getShopNameParts = (name) => {
                    const parts = name.split(/[\(Ôºà]/);
                    if (parts.length > 1) {
                        return { main: parts[0], sub: '(' + parts[1].replace(/[\)Ôºâ]/, '') + ')' };
                    }
                    return { main: name, sub: '' };
                };

                const getSimpleHours = (hours) => {
                    if (!hours) return '';
                    let simple = hours.split('|')[0].trim();
                    simple = simple.replace(/^(ÊòüÊúü|ÈÄ±|Âë®)[‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠Êó•Ëá≥\s]+/, '').trim();
                    return simple;
                };

                const initSortable = () => {
                    if (sortableList.value) {
                        sortableInstance = new Sortable(sortableList.value, {
                            animation: 150,
                            delay: 300, // Short hold to drag
                            delayOnTouchOnly: true, 
                            touchStartThreshold: 5, 
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            onEnd: (evt) => {
                                const movedItem = myData.value.days[currentDayIndex.value].events.splice(evt.oldIndex, 1)[0];
                                myData.value.days[currentDayIndex.value].events.splice(evt.newIndex, 0, movedItem);
                                updateTimesAfterDrag(); 
                                updateTripData(); 
                            }
                        });
                    }
                };

                const updateTimesAfterDrag = () => {
                    const dayEvents = myData.value.days[currentDayIndex.value].events;
                    const timeSlots = dayEvents.map(e => e.time).sort();
                    dayEvents.forEach((event, index) => { event.time = timeSlots[index]; });
                };

                 const openAddModal = () => {
                    isEditing.value = false;
                    editingEventIndex.value = null;
                    modalData.value = { time: '', title: '', desc: '', location: '', img: '' };
                    showModal.value = true;
                };

                const openEditModal = (index) => {
                    isEditing.value = true;
                    editingEventIndex.value = index;
                    modalData.value = { ...myData.value.days[currentDayIndex.value].events[index] };
                    showModal.value = true;
                };

                const closeModal = () => { showModal.value = false; };
                const openShopDetails = (shop) => { selectedShop.value = shop; showShopModal.value = true; };
                const closeShopModal = () => { showShopModal.value = false; setTimeout(() => selectedShop.value = null, 200); };
                
                const openAddShopModal = () => {
                     shopFormData.value = { name: '', type: 'Cafe', address: '', hours: '10:00 - 22:00', transport: '' };
                     showAddShopModal.value = true;
                };

                const saveEvent = () => {
                    if (!modalData.value.title) return alert('Ë´ãÂ°´ÂØ´Ê®ôÈ°å');
                    const newEvent = { ...modalData.value, id: Date.now() }; 
                    if (isEditing.value) {
                        myData.value.days[currentDayIndex.value].events[editingEventIndex.value] = newEvent;
                    } else {
                        myData.value.days[currentDayIndex.value].events.push(newEvent);
                    }
                    closeModal();
                    nextTick(() => { updateTimesAfterDrag(); updateTripData(); }); 
                };

                const deleteEvent = () => {
                    if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ë°åÁ®ãÂóéÔºü')) {
                        myData.value.days[currentDayIndex.value].events.splice(editingEventIndex.value, 1);
                        closeModal();
                        updateTripData(); 
                    }
                };

                const saveShop = () => {
                     if (!shopFormData.value.name) return alert('Ë´ãÂ°´ÂØ´Â∫óÂêç');
                     let iconColor = 'text-white';
                     if (shopFormData.value.type === 'Cafe') iconColor = 'text-yellow-600';
                     if (shopFormData.value.type === 'È§êÂª≥') iconColor = 'text-orange-400';
                     if (shopFormData.value.type === 'Èõ∂ÂîÆ') iconColor = 'text-green-400';

                     // Tag logic is removed from UI but we keep a dummy value or process name for it
                     // Or just default tag to Type if needed. For now empty tag is fine.
                     
                     const newShop = {
                         ...shopFormData.value,
                         tag: shopFormData.value.type, // Use type as tag since manual tag is removed
                         icon: '', // Handled by type
                         color: iconColor
                     };
                     
                     if (!myData.value.shops) myData.value.shops = [];
                     myData.value.shops.push(newShop);
                     updateTripData();
                     showAddShopModal.value = false;
                };

                const deleteShop = (shop) => {
                    if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Â∫óËàñÂóéÔºü')) {
                        myData.value.shops = myData.value.shops.filter(s => s !== shop);
                        updateTripData();
                        closeShopModal();
                    }
                };

                onMounted(() => { initSync(); });
                Vue.watch(currentTab, (newTab) => { if (newTab === 'schedule') { nextTick(() => initSortable()); } });
                Vue.watch(currentDayIndex, () => { if (sortableInstance) sortableInstance.destroy(); nextTick(() => initSortable()); });

                return {
                    currentTab, currentDayIndex, myData, getWeatherIcon, getShopIconColor, getShopCategoryIcon, getShopNameParts, getSimpleHours, sortableList, showModal, isEditing, modalData,
                    openAddModal, openEditModal, closeModal, saveEvent, deleteEvent, showShopModal, selectedShop, openShopDetails, closeShopModal,
                    isLoading, showAddShopModal, openAddShopModal, shopFormData, saveShop, deleteShop,
                    handleFileUpload, isUploading
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
